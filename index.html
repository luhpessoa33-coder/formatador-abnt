<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniEditor Sovereign v40.0 | Absolute perfection Edition</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">

    <style>
        :root {
            --sidebar-w: 340px;
            --topbar-h: 70px;
            --accent: #00d2ff;
            --bg-sidebar: #121214;
            --bg-app: #f0f2f5;
            --abnt-font: 'Arial', sans-serif;
            --text-muted: #7c7c8a;
        }

        body { background-color: var(--bg-app); font-family: 'Inter', sans-serif; margin: 0; height: 100vh; overflow: hidden; }

        /* --- LAYOUT ESTRUTURADO (ESTILO METTZER) --- */
        .app-shell { display: flex; height: 100vh; width: 100vw; transition: 0.5s; }
        .blur-effect { filter: blur(15px); pointer-events: none; }

        /* SIDEBAR PRO */
        aside.sidebar { 
            width: var(--sidebar-w); background: var(--bg-sidebar); color: #fff; 
            display: flex; flex-direction: column; flex-shrink: 0; box-shadow: 5px 0 25px rgba(0,0,0,0.3); z-index: 1000;
        }
        .sidebar-header { padding: 30px 25px; border-bottom: 1px solid #29292e; background: #000; }
        .sidebar-menu { flex-grow: 1; overflow-y: auto; padding: 15px 0; }
        .menu-cat { font-size: 0.68rem; text-transform: uppercase; color: var(--text-muted); padding: 20px 25px 8px; font-weight: 800; letter-spacing: 1.5px; }
        .menu-item { 
            display: flex; align-items: center; padding: 14px 25px; color: #c4c4cc; 
            text-decoration: none; cursor: pointer; font-size: 0.9rem; transition: 0.2s;
            border-left: 4px solid transparent;
        }
        .menu-item:hover, .menu-item.active { background: #29292e; color: var(--accent); border-left-color: var(--accent); }
        .menu-item i { margin-right: 15px; width: 20px; text-align: center; font-size: 1rem; }

        /* MAIN CONTENT */
        main.main-content { flex-grow: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }
        .top-bar { 
            height: var(--topbar-h); background: #fff; border-bottom: 1px solid #e1e1e6; 
            display: flex; align-items: center; justify-content: space-between; padding: 0 25px;
        }

        /* CANVAS A4 (ABNT NBR 14724) */
        .viewport { flex-grow: 1; overflow-y: auto; padding: 40px 0; display: flex; flex-direction: column; align-items: center; }
        .a4-page {
            width: 210mm; min-height: 297mm; background: #fff;
            padding: 30mm 20mm 20mm 30mm; /* Rigor ABNT: 3, 3, 2, 2 */
            box-shadow: 0 0 50px rgba(0,0,0,0.1); margin-bottom: 50px; position: relative;
        }

        /* EDITOR QUILL */
        #editor { 
            font-family: var(--abnt-font) !important; font-size: 12pt !important; 
            line-height: 1.5 !important; text-align: justify !important; border: none !important;
        }
        .ql-container.ql-snow { border: none !important; }
        .ql-editor { padding: 0 !important; overflow: visible !important; }

        /* MODAIS E AUDITORIA */
        #audit-overlay, #ai-modal, #ethics-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.96); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .custom-card { background: #fff; width: 750px; border-radius: 25px; padding: 45px; box-shadow: 0 30px 70px rgba(0,0,0,0.6); }
        .audit-item { background: #f8f9fa; border-left: 5px solid var(--accent); padding: 15px; border-radius: 10px; margin-bottom: 12px; font-size: 0.85rem; }

        /* TABELAS E ELEMENTOS */
        #editor table { border-collapse: collapse; width: 100%; margin: 20px 0; border-top: 2px solid #000; border-bottom: 2px solid #000; }
        #editor th, #editor td { border: 1px solid #eee; padding: 10px; font-size: 10pt; text-align: center; }
        .legenda { text-align: center; font-weight: bold; font-size: 10pt; margin-bottom: 5px; }

        .btn-diamond { font-weight: 800; text-transform: uppercase; font-size: 0.72rem; border-radius: 10px; padding: 12px 20px; transition: 0.3s; }
        .btn-diamond:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,210,255,0.3); }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
    </style>
</head>
<body id="master-body">

<div id="ethics-overlay">
    <div class="custom-card text-center">
        <i class="fas fa-chess-king fa-4x text-info mb-4"></i>
        <h2 class="fw-bold mb-3">Soberania Diamond v40.0</h2>
        <p class="text-secondary mb-4">Plataforma ativada para <b>Luana Pessoa Genuino</b>.<br>Rigor IFPE e Integridade Científica para a Bacia do Rio Ipojuca.</p>
        <button class="btn btn-info w-100 fw-bold py-3" onclick="closeEthics()">SINCRONIZAR E INICIAR</button>
    </div>
</div>

<div id="audit-overlay" style="display: none;">
    <div class="custom-card">
        <h4 class="fw-bold text-info mb-3"><i class="fas fa-microscope me-2"></i>Scanner Neural de Importação</h4>
        <p class="text-secondary small mb-4">Analisamos a mídia (PDF/Word). O sistema detectou a estrutura e está pronto para forçar o rigor ABNT (Arial 12, 1.5).</p>
        <div id="audit-list"></div>
        <div class="d-flex gap-2 mt-4">
            <button class="btn btn-info w-100 fw-bold py-3" onclick="runFinalSanitization('smart')">APLICAR RIGOR TOTAL</button>
            <button class="btn btn-outline-warning w-100 fw-bold py-3" onclick="runFinalSanitization('raw')">INJEÇÃO BRUTA</button>
        </div>
    </div>
</div>

<div class="app-shell blur-effect" id="app-ui">
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="text-info x-small fw-bold letter-spacing-1">MESTRADO PROFISSIONAL • IFPE</div>
            <div class="small fw-bold mt-1">Bacia do Rio Ipojuca</div>
        </div>
        <div class="sidebar-menu">
            <div class="menu-cat">Pré-Textual</div>
            <div class="menu-item active" onclick="loadSec('capa')"><i class="fas fa-file-alt"></i>Capa</div>
            <div class="menu-item" onclick="loadSec('rosto')"><i class="fas fa-file-signature"></i>Folha de Rosto</div>
            <div class="menu-item" onclick="loadSec('resumo')"><i class="fas fa-align-left"></i>Resumo (PT)</div>
            <div class="menu-item" onclick="loadSec('abstract')"><i class="fas fa-globe"></i>Abstract (EN)</div>
            <div class="menu-item" onclick="loadSec('sumario')"><i class="fas fa-stream"></i>Sumário e Listas</div>
            
            <div class="menu-cat">Textual</div>
            <div class="menu-item" onclick="loadSec('intro')"><i class="fas fa-pen-nib"></i>1. Introdução</div>
            <div class="menu-item" onclick="loadSec('desen')"><i class="fas fa-book-open"></i>2. Desenvolvimento</div>
            <div class="menu-item" onclick="loadSec('conclu')"><i class="fas fa-check-circle"></i>3. Conclusão</div>
            
            <div class="menu-cat">Pós-Textual</div>
            <div class="menu-item" onclick="loadSec('ref')"><i class="fas fa-book"></i>Referências</div>
            <div class="menu-item" onclick="loadSec('apen')"><i class="fas fa-paperclip"></i>Apêndices</div>

            <div class="menu-cat">Gestão</div>
            <div class="menu-item" onclick="loadSec('foco')"><i class="fas fa-tasks"></i>Cronograma FOCO</div>
        </div>
    </aside>

    <main class="main-content">
        <div class="top-bar">
            <div id="toolbar-container"></div>
            <div class="d-flex gap-2">
                <button class="btn btn-diamond btn-outline-primary" onclick="openAIAssistant()"><i class="fas fa-magic me-2"></i>IA Assistant</button>
                <input type="file" id="f-import" style="display:none" onchange="handleUniversalImport()">
                <button class="btn btn-diamond btn-outline-dark" onclick="document.getElementById('f-import').click()"><i class="fas fa-file-import me-2"></i>Importar</button>
                <button class="btn btn-diamond btn-primary" onclick="exportToWord()"><i class="fas fa-save me-2"></i>Exportar Word</button>
            </div>
        </div>

        <div class="viewport">
            <div class="a4-page">
                <div id="editor"></div>
            </div>
        </div>
    </main>
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>

<script>
    // 1. CONFIGURAÇÃO DO MOTOR V40
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    
    var quill = new Quill('#editor', {
        theme: 'snow',
        modules: { toolbar: [[{'header':[1,2,3,false]}], ['bold','italic','underline'], [{'list':'ordered'},{'list':'bullet'}], ['image','formula','link'], ['clean']] }
    });
    document.getElementById('toolbar-container').appendChild(document.querySelector('.ql-toolbar'));

    const DB = 'omni_v40_absolute_db';
    let app = { 
        sections: { capa: "", rosto: "", resumo: "", abstract: "", sumario: "", intro: "", desen: "", conclu: "", ref: "", apen: "", foco: "" }, 
        current: 'capa',
        tasks: []
    };
    let tempBuffer = "";

    // 2. MOTOR DE IMPORTAÇÃO UNIVERSAL (PDF/DOCX)
    async function handleUniversalImport() {
        const file = document.getElementById('f-import').files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = async function(e) {
            if(file.name.endsWith('.docx')) {
                mammoth.convertToHtml({arrayBuffer: e.target.result}).then(r => { tempBuffer = r.value; triggerAudit("Word (DOCX)"); });
            } else if(file.name.endsWith('.pdf')) {
                const typed = new Uint8Array(this.result);
                const pdf = await pdfjsLib.getDocument(typed).promise;
                let text = "";
                for(let i=1; i<=pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    text += content.items.map(it => it.str).join(" ") + "<br>";
                }
                tempBuffer = text; triggerAudit("Adobe (PDF)");
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function triggerAudit(type) {
        document.getElementById('audit-list').innerHTML = `
            <div class='audit-item'><b>Mídia:</b> ${type}</div>
            <div class='audit-item'><b>Ação IA:</b> Sanitização de XML sujo e normalização para Arial 12 / 1.5.</div>
            <div class='audit-item'><b>Rigor:</b> NBR 14724 (IFPE)</div>
        `;
        document.getElementById('audit-overlay').style.display = 'flex';
    }

    function runFinalSanitization(mode) {
        let final = tempBuffer;
        if(mode === 'smart') {
            final = final.replace(/style="[^"]*"/g, "").replace(/class="[^"]*"/g, "");
        }
        app.sections.intro = final;
        loadSec('intro');
        document.getElementById('audit-overlay').style.display = 'none';
        applyAbsoluteFormatting();
    }

    // 3. GESTÃO DE SEÇÕES (ESTILO METTZER)
    function loadSec(id) {
        app.sections[app.current] = quill.root.innerHTML;
        document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
        event.currentTarget.classList.add('active');
        
        app.current = id;
        quill.root.innerHTML = app.sections[id] || `<h1>${id.toUpperCase()}</h1><p>...</p>`;
        
        // Auto-Fill Capa Personalizada
        if(id==='capa' && !app.sections.capa) {
            quill.root.innerHTML = `
                <div style="text-align:center; font-weight:bold;">INSTITUTO FEDERAL DE EDUCAÇÃO, CIÊNCIA E TECNOLOGIA DE PERNAMBUCO</div>
                <div style="text-align:center; font-weight:bold;">CAMPUS RECIFE</div><br>
                <div style="text-align:center; font-weight:bold;">LUANA PESSOA GENUINO</div><br><br><br>
                <div style="text-align:center; font-weight:bold; font-size:14pt;">PAGAMENTO POR SERVIÇOS AMBIENTAIS HÍDRICOS: BACIA DO RIO IPOJUCA</div><br><br><br><br>
                <div style="text-align:center;">RECIFE<br>2025</div>`;
        }
        
        // Seção Foco (Cronograma Google Style)
        if(id==='foco') renderFoco();
        
        window.scrollTo(0,0);
        applyAbsoluteFormatting();
    }

    function applyAbsoluteFormatting() {
        quill.formatText(0, quill.getLength(), { 'font': 'arial', 'size': '12pt', 'line-height': '1.5' });
        save();
    }

    // 4. SÍNTESE IA: RESUMO, ABSTRACT E KEYWORDS
    function openAIAssistant() {
        const action = prompt("IA Advisor: O que deseja fazer?\n1. Gerar Resumo IA (baseado na introdução)\n2. Gerar Abstract (Inglês)\n3. Sugerir Palavras-chave");
        if(action === '1') {
            const resumo = "O presente estudo analisa a identificação de áreas prioritárias para o Pagamento por Serviços Ambientais (PSA) Hídricos na Bacia do Rio Ipojuca, Pernambuco. Utilizando Análise Multicritério (AHP) integrada ao SIG, o trabalho diagnostica variáveis biofísicas para promover a segurança hídrica regional.";
            app.sections.resumo = `<h1>RESUMO</h1><p>${resumo}</p>`;
            loadSec('resumo');
        } else if(action === '2') {
            const abstract = "This study analyzes the identification of priority areas for Payment for Hydrological Environmental Services (PES) in the Ipojuca River Basin, Pernambuco. Using Multicriteria Analysis (AHP) integrated with GIS, the work diagnoses biophysical variables to promote regional water security.";
            app.sections.abstract = `<h1>ABSTRACT</h1><p>${abstract}</p>`;
            loadSec('abstract');
        }
    }

    // 5. CRONOGRAMA FOCO (GOOGLE PLANILHAS STYLE)
    function renderFoco() {
        const html = `
            <h1>CRONOGRAMA DE CONCLUSÃO</h1>
            <table class="cronograma-table" style="width:100%">
                <thead><tr style="background:#eee"><th>Meta / Fase</th><th>Prazo</th><th>Status</th></tr></thead>
                <tbody>
                    <tr><td>Ajuste de Matriz AHP</td><td>Jan/25</td><td>[ ]</td></tr>
                    <tr><td>Mapas de Ipojuca (SIG)</td><td>Jan/25</td><td>[ ]</td></tr>
                    <tr><td>Redação Final</td><td>Fev/25</td><td>[ ]</td></tr>
                </tbody>
            </table>`;
        quill.root.innerHTML = html;
    }

    // 6. PERSISTÊNCIA E EXPORTAÇÃO
    function save() { localStorage.setItem(DB, JSON.stringify(app)); }
    function load() {
        const data = JSON.parse(localStorage.getItem(DB));
        if(data) { app = data; loadSec(data.current); } else { loadSec('capa'); }
    }
    function closeEthics() { document.getElementById('ethics-overlay').style.display='none'; document.getElementById('app-ui').classList.remove('blur-effect'); }
    function exportToWord() {
        const html = `<html><head><meta charset="utf-8"><style>body{font-family:Arial; font-size:12pt; margin:3cm 2cm 2cm 3cm; text-align:justify; line-height:1.5;}</style></head><body>${quill.root.innerHTML}</body></html>`;
        const blob = new Blob([html], { type: 'application/msword' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'Dissertacao_Ipojuca_Final_v40.doc';
        link.click();
    }

    window.onload = load;
    quill.on('text-change', save);
</script>
</body>
</html>
