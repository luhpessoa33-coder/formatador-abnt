<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniEditor Sovereign v48.0 | Engenharia Acadêmica Total</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">

    <style>
        :root {
            --sidebar-w: 360px; --topbar-h: 75px; --accent: #00d2ff;
            --bg-sidebar: #0a0a0c; --bg-canvas: #eef0f2; --abnt-font: 'Arial', sans-serif;
            --text-main: #c4c4cc; --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body { background-color: var(--bg-canvas); font-family: 'Inter', sans-serif; margin: 0; height: 100vh; display: flex; overflow: hidden; }

        /* --- LOGIN MASTER DE SOBERANIA --- */
        #master-login-overlay { position: fixed; inset: 0; background: #000; z-index: 50000; display: flex; align-items: center; justify-content: center; }
        .login-card { width: 450px; padding: 50px; background: #121214; border-radius: 28px; border: 2px solid var(--accent); text-align: center; box-shadow: 0 0 100px rgba(0,210,255,0.3); }

        /* --- LAYOUT DA PLATAFORMA --- */
        .app-shell { display: flex; width: 100vw; height: 100vh; visibility: hidden; opacity: 0; transition: var(--transition); }
        .app-shell.active { visibility: visible; opacity: 1; }

        /* SIDEBAR ESTRUTURADA (ESTILO METTZER) */
        aside.sidebar { 
            width: var(--sidebar-w); background: var(--bg-sidebar); color: #fff; 
            display: flex; flex-direction: column; flex-shrink: 0; box-shadow: 15px 0 40px rgba(0,0,0,0.4); z-index: 1000;
        }
        .sidebar-header { padding: 30px; border-bottom: 1px solid #29292e; }
        .sidebar-menu { flex-grow: 1; overflow-y: auto; padding: 15px 0; }
        .menu-cat { font-size: 0.65rem; text-transform: uppercase; color: #666; padding: 20px 30px 8px; font-weight: 800; letter-spacing: 2px; }
        .menu-item { 
            display: flex; align-items: center; padding: 14px 30px; color: var(--text-main); 
            text-decoration: none; cursor: pointer; font-size: 0.92rem; border-left: 4px solid transparent; transition: var(--transition);
        }
        .menu-item:hover, .menu-item.active { background: #1a1a1e; color: var(--accent); border-left-color: var(--accent); }
        .menu-item i { margin-right: 18px; width: 22px; text-align: center; font-size: 1.1rem; }

        /* ÁREA DE CONTEÚDO PRINCIPAL */
        main.main-content { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .top-bar { 
            height: var(--topbar-h); background: #fff; border-bottom: 1px solid #e1e1e6; 
            display: flex; align-items: center; justify-content: space-between; padding: 0 35px;
        }

        /* CANVAS A4 RIGOROSO (NBR 14724) */
        .viewport { flex-grow: 1; overflow-y: auto; padding: 50px 0; display: flex; flex-direction: column; align-items: center; background: #eef0f2; scroll-behavior: smooth; }
        .a4-page {
            width: 210mm; min-height: 297mm; background: #fff;
            /* MARGENS RÍGIDAS: SUP/ESQ 3CM, INF/DIR 2CM */
            padding: 30mm 20mm 20mm 30mm; 
            box-shadow: 0 0 60px rgba(0,0,0,0.1); position: relative; margin-bottom: 60px;
        }

        /* EDITOR E TIPOGRAFIA */
        #editor { 
            font-family: var(--abnt-font) !important; font-size: 12pt !important; 
            line-height: 1.5 !important; text-align: justify !important; border: none !important;
        }
        .ql-container.ql-snow { border: none !important; }
        .ql-editor { padding: 0 !important; overflow: visible !important; }

        /* MODAIS E INTERFACES IA */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.96); display: none; align-items: center; justify-content: center; z-index: 20000; }
        .modal-card { background: #fff; width: 850px; border-radius: 25px; padding: 45px; box-shadow: 0 40px 100px rgba(0,0,0,0.5); border-top: 10px solid var(--accent); max-height: 90vh; overflow-y: auto; }

        /* HUB DE PESQUISA */
        .search-item { border-bottom: 1px solid #eee; padding: 20px 0; }
        .badge-base { font-size: 0.6rem; font-weight: 800; padding: 4px 8px; border-radius: 4px; margin-bottom: 5px; display: inline-block; }

        /* ADVISOR CHAT */
        #chat-window { height: 350px; overflow-y: auto; background: #f8f9fa; border-radius: 15px; padding: 20px; border: 1px solid #eee; margin-bottom: 15px; }
        .msg { padding: 12px 18px; border-radius: 15px; margin-bottom: 10px; font-size: 0.9rem; max-width: 85%; }
        .msg-advisor { background: #e1f5fe; border-left: 5px solid var(--accent); }
        .msg-user { background: #eee; margin-left: auto; text-align: right; }

        /* BOTÕES PRO */
        .btn-diamond { font-weight: 800; text-transform: uppercase; font-size: 0.75rem; border-radius: 10px; padding: 12px 25px; transition: 0.3s; border: none; cursor: pointer; }
        .btn-diamond:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,210,255,0.3); }

        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
    </style>
</head>
<body id="master-body">

<div id="master-login-overlay">
    <div class="login-card">
        <i class="fas fa-fingerprint fa-4x text-info mb-4"></i>
        <h3 class="fw-bold text-white mb-2">OmniEditor Master Login</h3>
        <p class="text-muted small mb-4">Insira a Chave de Soberania para acessar o projeto Luana Genuino.</p>
        <input type="password" id="master-pass" class="form-control mb-3 bg-dark text-white text-center py-3" placeholder="Chave de Acesso">
        <button class="btn btn-info w-100 fw-bold py-3 text-white" onclick="unlockApp()">AUTENTICAR PLATAFORMA</button>
    </div>
</div>

<div class="app-shell" id="app-root">
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="text-info x-small fw-bold">MESTRADO PROFISSIONAL • IFPE</div>
            <div class="small fw-bold mt-1 text-uppercase">Bacia do Rio Ipojuca</div>
        </div>
        <div class="sidebar-menu">
            <div class="menu-cat">Elementos Pré-Textuais</div>
            <div class="menu-item active" onclick="switchSection('capa')"><i class="fas fa-file-alt"></i>Capa</div>
            <div class="menu-item" onclick="switchSection('rosto')"><i class="fas fa-file-signature"></i>Folha de Rosto</div>
            <div class="menu-item" onclick="switchSection('resumo')"><i class="fas fa-align-left"></i>Resumo (PT)</div>
            <div class="menu-item" onclick="switchSection('abstract')"><i class="fas fa-globe"></i>Abstract (EN)</div>
            <div class="menu-item" onclick="switchSection('sumario')"><i class="fas fa-list-ol"></i>Sumário e Listas</div>
            
            <div class="menu-cat">Elementos Textuais</div>
            <div class="menu-item" onclick="switchSection('intro')"><i class="fas fa-pen-nib"></i>1. Introdução</div>
            <div class="menu-item" onclick="switchSection('metod')"><i class="fas fa-layer-group"></i>2. Metodologia AHP</div>
            <div class="menu-item" onclick="switchSection('desen')"><i class="fas fa-book-open"></i>3. Desenvolvimento</div>
            <div class="menu-item" onclick="switchSection('conclu')"><i class="fas fa-check-circle"></i>4. Conclusão</div>
            
            <div class="menu-cat">Gestão e Inteligência</div>
            <div class="menu-item" onclick="openSearchHub()"><i class="fas fa-search-plus"></i>Hub de Pesquisa Total</div>
            <div class="menu-item" onclick="openAdvisorChat()"><i class="fas fa-comments"></i>Chat Advisor IA</div>
            <div class="menu-item" onclick="switchSection('foco')"><i class="fas fa-tasks"></i>Cronograma FOCO</div>
            <div class="menu-item" onclick="switchSection('ref')"><i class="fas fa-book"></i>Referências ABNT</div>
        </div>
    </aside>

    <main class="main-content">
        <div class="top-bar">
            <div id="toolbar-container"></div>
            <div class="d-flex gap-2">
                <button class="btn btn-diamond btn-outline-info" onclick="generateResumoIA()"><i class="fas fa-magic me-2"></i>Síntese IA</button>
                <input type="file" id="f-import" style="display:none" onchange="handleUniversalImport()">
                <button class="btn btn-diamond btn-outline-dark" onclick="document.getElementById('f-import').click()"><i class="fas fa-file-import me-2"></i>Importar</button>
                <button class="btn btn-diamond btn-primary" onclick="exportFinalWord()" style="background:var(--accent); color:#000;"><i class="fas fa-save me-2"></i>Exportar Word</button>
            </div>
        </div>

        <div class="viewport">
            <div class="a4-page">
                <div id="editor"></div>
            </div>
        </div>
    </main>
</div>

<div id="search-hub-modal" class="modal-overlay">
    <div class="modal-card">
        <h4 class="fw-bold mb-3 text-dark"><i class="fas fa-globe text-info me-2"></i>Hub de Pesquisa Científica Federada</h4>
        <div class="input-group mb-4">
            <input type="text" id="q-search" class="form-control py-3" placeholder="Termos de busca (ex: PSA Hídrico Bacia Ipojuca AHP)">
            <select id="cite-style" class="form-select" style="max-width: 140px;"><option value="ABNT">ABNT</option><option value="APA">APA</option></select>
            <button class="btn btn-info text-white fw-bold px-4" onclick="runFederatedSearch()">PESQUISAR</button>
        </div>
        <div class="d-flex flex-wrap gap-2 mb-4">
            <span class="badge bg-dark">ANA</span><span class="badge bg-dark">Scholar</span><span class="badge bg-dark">SciELO</span>
            <span class="badge bg-dark">BDTD</span><span class="badge bg-dark">Dimensions</span><span class="badge bg-dark">ScienceDirect</span>
        </div>
        <div id="search-results-box" class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;">
            </div>
        <div class="mt-4 text-end">
            <button class="btn btn-secondary" onclick="closeSearchHub()">Fechar Hub</button>
        </div>
    </div>
</div>

<div id="advisor-modal" class="modal-overlay">
    <div class="modal-card" style="width: 550px;">
        <h4 class="fw-bold mb-3"><i class="fas fa-robot text-info me-2"></i>Advisor IA Acadêmico</h4>
        <div id="chat-window">
            <div class="msg msg-advisor">Olá Luana! Sou seu Advisor v48. Estou analisando seu trabalho sobre a Bacia do Rio Ipojuca. Como posso ajudar na sua metodologia hoje?</div>
        </div>
        <div class="input-group">
            <input type="text" id="chat-msg" class="form-control" placeholder="Digite sua dúvida ou peça um parágrafo...">
            <button class="btn btn-info text-white" onclick="sendChatToAdvisor()"><i class="fas fa-paper-plane"></i></button>
        </div>
        <div class="mt-3 text-center">
            <button class="btn btn-sm btn-link text-muted" onclick="closeAdvisorChat()">Minimizar Advisor</button>
        </div>
    </div>
</div>

<div id="audit-modal" class="modal-overlay">
    <div class="modal-card">
        <h4 class="fw-bold mb-3"><i class="fas fa-microscope text-info me-2"></i>Auditoria de Importação IA</h4>
        <p class="text-secondary small mb-4">Analisamos a mídia carregada. O sistema detectou a estrutura visual e está pronto para forçar o rigor ABNT (Arial 12, 1.5).</p>
        <div id="audit-report-box" class="bg-light p-3 rounded mb-4"></div>
        <div class="d-flex gap-3">
            <button class="btn btn-info w-100 fw-bold py-3 text-white" onclick="finalizeImport('smart')">APLICAR RIGOR E INDEXAR</button>
            <button class="btn btn-outline-warning w-100 fw-bold py-3" onclick="finalizeImport('raw')">INJETAR CONTEÚDO BRUTO</button>
        </div>
    </div>
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>

<script>
    // 1. CONFIGURAÇÃO E LOGIN MASTER
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    
    function unlockApp() {
        if(document.getElementById('master-pass').value === 'master2026') {
            document.getElementById('master-login-overlay').style.display = 'none';
            document.getElementById('app-root').classList.add('active');
        } else { alert('Chave Diamond Inválida'); }
    }

    // 2. EDITOR E ESTADO MODULAR (SISTEMA DE GAVETAS)
    var quill = new Quill('#editor', {
        theme: 'snow',
        modules: { toolbar: [[{'header':[1,2,3,false]}],['bold','italic','underline'],[{'list':'ordered'},{'list':'bullet'}],['image','formula','link'],['clean']] }
    });
    document.getElementById('toolbar-container').appendChild(document.querySelector('.ql-toolbar'));

    const DATABASE = 'omni_v48_absolute_db';
    let app = { 
        sections: { capa: "", rosto: "", resumo: "", abstract: "", sumario: "", intro: "", metod: "", desen: "", conclu: "", ref: "", foco: "" }, 
        current: 'capa'
    };
    let tempRawBuffer = "";

    function switchSection(id) {
        // Salva o conteúdo da aba atual antes de trocar
        app.sections[app.current] = quill.root.innerHTML;
        
        // Atualiza a barra lateral
        document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
        const activeItem = Array.from(document.querySelectorAll('.menu-item')).find(el => el.getAttribute('onclick').includes(id));
        if(activeItem) activeItem.classList.add('active');

        // Carrega a nova aba
        app.current = id;
        quill.root.innerHTML = app.sections[id] || `<h1>${id.toUpperCase()}</h1><p>Inicie aqui sua redação...</p>`;
        
        // Templates de Soberania Luana
        if(id==='capa' && !app.sections.capa) {
            quill.root.innerHTML = `<div style="text-align:center; font-weight:bold;">INSTITUTO FEDERAL DE PERNAMBUCO - IFPE</div><br><div style="text-align:center; font-weight:bold;">LUANA PESSOA GENUINO</div><br><br><br><div style="text-align:center; font-weight:bold; font-size:14pt;">PAGAMENTO POR SERVIÇOS AMBIENTAIS HÍDRICOS: IDENTIFICAÇÃO DE ÁREAS PRIORITÁRIAS NA BACIA DO RIO IPOJUCA</div><br><br><br><br><div style="text-align:center;">RECIFE<br>2026</div>`;
        }
        if(id==='foco') renderFocoSheet();
        
        window.scrollTo(0,0);
        applyAbsoluteABNT();
    }

    function applyAbsoluteABNT() {
        quill.formatText(0, quill.getLength(), { 'font': 'arial', 'size': '12pt', 'line-height': '1.5' });
        persistData();
    }

    // 3. HUB DE PESQUISA E CITAÇÃO AUTOMÁTICA
    function openSearchHub() { document.getElementById('search-hub-modal').style.display = 'flex'; }
    function closeSearchHub() { document.getElementById('search-hub-modal').style.display = 'none'; }
    
    function runFederatedSearch() {
        const q = document.getElementById('q-search').value;
        const style = document.getElementById('cite-style').value;
        const results = [
            { base: 'ANA', title: 'Gestão de PSA na Bacia do Rio Ipojuca', auth: 'Silva, M.', year: '2024' },
            { base: 'SciELO', title: 'Análise Multicritério (AHP) em Recursos Hídricos', auth: 'Oliveira, R.', year: '2023' }
        ];
        document.getElementById('search-results-box').innerHTML = results.map(r => `
            <div class="search-item">
                <span class="badge-base bg-info text-dark">${r.base}</span><br>
                <strong>${r.title}</strong><br><small>${r.auth} (${r.year})</small><br>
                <button class="btn btn-cite btn-info text-white mt-2" onclick="injectCite('${r.auth}', '${r.year}', '${style}')">Citar ${style} no Texto</button>
            </div>
        `).join('');
    }

    function injectCite(auth, year, style) {
        const cite = style === 'ABNT' ? `(${auth.toUpperCase()}, ${year})` : `(${auth}, ${year})`;
        const range = quill.getSelection() || { index: 0 };
        quill.insertText(range.index, cite);
        closeSearchHub();
        persistData();
    }

    // 4. CHAT ADVISOR IA
    function openAdvisorChat() { document.getElementById('advisor-modal').style.display = 'flex'; }
    function closeAdvisorChat() { document.getElementById('advisor-modal').style.display = 'none'; }
    function sendChatToAdvisor() {
        const msg = document.getElementById('chat-msg').value;
        const box = document.getElementById('chat-window');
        box.innerHTML += `<div class="msg msg-user">${msg}</div>`;
        setTimeout(() => {
            box.innerHTML += `<div class="msg msg-advisor"><strong>Advisor:</strong> Detectei que sua Bacia do Ipojuca possui alta erodibilidade. Recomendo que no capítulo 2 (Metodologia) você detalhe os pesos da Matriz AHP para o fator solo. Deseja uma sugestão de parágrafo?</div>`;
            box.scrollTop = box.scrollHeight;
        }, 1000);
        document.getElementById('chat-msg').value = "";
    }

    // 5. MOTOR DE IMPORTAÇÃO UNIVERSAL (SANEAMENTO RADICAL)
    async function handleUniversalImport() {
        const file = document.getElementById('f-import').files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = async function(e) {
            if(file.name.endsWith('.docx')) {
                mammoth.convertToHtml({arrayBuffer: e.target.result}).then(r => { 
                    tempRawBuffer = r.value; 
                    triggerAuditReport("Word (.docx)"); 
                });
            } else if(file.name.endsWith('.pdf')) {
                const typed = new Uint8Array(this.result);
                const pdf = await pdfjsLib.getDocument(typed).promise;
                let text = "";
                for(let i=1; i<=pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    text += content.items.map(it => it.str).join(" ") + "<br>";
                }
                tempRawBuffer = text; 
                triggerAuditReport("Adobe PDF (.pdf)");
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function triggerAuditReport(media) {
        document.getElementById('audit-report-box').innerHTML = `<b>Mídia:</b> ${media}<br><b>Ação:</b> Sanitização de XML sujo e normalização ABNT NBR 14724 ativa.`;
        document.getElementById('audit-modal').style.display = 'flex';
    }

    function finalizeImport(mode) {
        let clean = tempRawBuffer;
        if(mode === 'smart') {
            clean = clean.replace(/style="[^"]*"/g, "").replace(/class="[^"]*"/g, "").replace(/font-family:[^;]*;/g, "");
        }
        app.sections.intro = clean;
        switchSection('intro');
        document.getElementById('audit-modal').style.display = 'none';
        applyAbsoluteABNT();
    }

    function generateResumoIA() {
        const resumo = "O presente estudo analisa a identificação de áreas prioritárias para o Pagamento por Serviços Ambientais (PSA) Hídricos na Bacia do Rio Ipojuca, Pernambuco. Através da Análise Multicritério (AHP) integrada ao SIG, o trabalho diagnostica variáveis biofísicas e socioeconômicas para subsidiar a gestão hídrica.";
        app.sections.resumo = `<h1>RESUMO</h1><p>${resumo}</p><br><p><b>Palavras-chave:</b> Ipojuca. AHP. SIG. PSA Hídrico.</p>`;
        switchSection('resumo');
    }

    function renderFocoSheet() {
        quill.root.innerHTML = `<h1>CRONOGRAMA FOCO</h1><table style="width:100%; border-collapse:collapse;"><tr><th style="border:1px solid #ddd; padding:10px; background:#f4f4f4;">Meta</th><th style="border:1px solid #ddd; padding:10px; background:#f4f4f4;">Status</th></tr><tr><td style="border:1px solid #ddd; padding:10px;">Finalizar Mapas SIG Ipojuca</td><td style="border:1px solid #ddd; padding:10px;">[Em andamento]</td></tr></table>`;
    }

    // 6. PERSISTÊNCIA E EXPORTAÇÃO
    function persistData() { localStorage.setItem(DATABASE, JSON.stringify(app)); }
    function loadExistingData() {
        const stored = JSON.parse(localStorage.getItem(DATABASE));
        if(stored) { app = stored; switchSection(stored.current); }
        else { switchSection('capa'); }
    }
    function exportFinalWord() {
        const html = `<html><head><meta charset="utf-8"><style>body{font-family:Arial; font-size:12pt; margin:3cm 2cm 2cm 3cm; text-align:justify; line-height:1.5;}</style></head><body>${quill.root.innerHTML}</body></html>`;
        const blob = new Blob([html], { type: 'application/msword' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Dissertacao_Final_v48.doc'; a.click();
    }

    window.onload = loadExistingData;
    quill.on('text-change', persistData);
</script>
</body>
</html>
