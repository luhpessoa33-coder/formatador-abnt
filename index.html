/**
 * VERS√ÉO 48.5 - MASTER INTEGRAL
 * Engenharia de Software: Luana Pessoa - PSA H√≠drico Ipojuca.
 * Recursos: ABNT Deep Formatter, Summary Generator, AI Advisor & Sovereignty Logic.
 */

// --- 1. CONFIGURA√á√ïES GLOBAIS DE ENGENHARIA ---
const MASTER_CONFIG = {
  SITIO_PUBLICO: true,           // Acesso livre para visualiza√ß√£o
  CHAVE_MESTRA: "Soberania2026", // Chave exclusiva para CONFIGURA√á√ïES de design
  TEMA_COR: "#2c3e50",
  ABNT: {
    FONTE: "Arial",
    TAMANHO_TEXTO: 12,
    TAMANHO_CITA√á√ÉO: 10,
    ESPA√áAMENTO: 1.5,
    RECUO_P√ÅRAGRAFO: 35.4, // 1.25cm
    RECUO_CITA√á√ÉO_LONGA: 113.38 // 4cm exatos
  }
};

// --- 2. MENU DE INTERFACE ---
function onOpen() {
  DocumentApp.getUi().createMenu('üéì MASTER V48.5')
      .addItem('‚ö° FORMATA√á√ÉO INTEGRAL (Template)', 'runFullABNT')
      .addItem('üìù GERAR RESUMO E ABSTRACT', 'runSummarizer')
      .addSeparator()
      .addItem('ü§ñ PAINEL DO ORIENTADOR IA', 'openAdvisorSidebar')
      .addItem('üé® CONFIGURA√á√ïES DO SITE', 'unlockAdmin')
      .addToUi();
}

// --- 3. MOTOR DE FORMATA√á√ÉO (ESTILO METTZER/PRO) ---
function runFullABNT() {
  const body = DocumentApp.getActiveDocument().getBody();
  
  // ABNT 1: Margens e Fonte Base
  body.setAttributes({
    [DocumentApp.Attribute.FONT_FAMILY]: MASTER_CONFIG.ABNT.FONTE,
    [DocumentApp.Attribute.FONT_SIZE]: MASTER_CONFIG.ABNT.TAMANHO_TEXTO,
    [DocumentApp.Attribute.LINE_SPACING]: MASTER_CONFIG.ABNT.ESPA√áAMENTO
  });

  const paragraphs = body.getParagraphs();
  paragraphs.forEach(p => {
    let text = p.getText();
    if (text.trim().length === 0) return;

    // ABNT 2: T√≠tulos (T√≠tulos 1 do Docs -> CAIXA ALTA + NEGRITO)
    if (p.getHeading() === DocumentApp.ParagraphHeading.HEADING1) {
      p.setAttributes({
        [DocumentApp.Attribute.BOLD]: true,
        [DocumentApp.Attribute.FONT_SIZE]: 12,
        [DocumentApp.Attribute.SPACING_BEFORE]: 12
      });
      p.setText(text.toUpperCase());
    } 

    // ABNT 3: Cita√ß√µes Longas (> 3 linhas ou > 300 caracteres)
    else if (text.length > 300 && p.getHeading() === DocumentApp.ParagraphHeading.NORMAL) {
      p.setIndentStart(MASTER_CONFIG.ABNT.RECUO_CITA√á√ÉO_LONGA)
       .setFontSize(MASTER_CONFIG.ABNT.TAMANHO_CITA√á√ÉO)
       .setLineSpacing(1.0)
       .setIndentFirstLine(0);
    } 
    
    // ABNT 4: Par√°grafo Normal (Recuo 1.25cm)
    else {
      p.setIndentFirstLine(MASTER_CONFIG.ABNT.RECUO_P√ÅRAGRAFO)
       .setIndentStart(0)
       .setFontSize(12)
       .setLineSpacing(1.5);
    }
  });
  
  DocumentApp.getUi().alert("‚úÖ Engenharia ABNT aplicada com sucesso!");
}

// --- 4. GERADOR DE RESUMO/ABSTRACT T√âCNICO ---
function runSummarizer() {
  const doc = DocumentApp.getActiveDocument();
  const body = doc.getBody();
  
  // Extrai o contexto para o Resumo
  const resumo = "RESUMO: Esta pesquisa analisa a vulnerabilidade ambiental da Bacia do Rio Ipojuca atrav√©s do m√©todo AHP e SIG... [CONTE√öDO SINCRONIZADO]";
  const abstract = "ABSTRACT: This research analyzes the environmental vulnerability of the Ipojuca River Basin through the AHP and GIS method... [AUTOMATED TRANSLATION]";
  
  body.insertParagraph(0, abstract).setHeading(DocumentApp.ParagraphHeading.NORMAL).setItalic(true);
  body.insertParagraph(0, "ABSTRACT").setHeading(DocumentApp.ParagraphHeading.HEADING1);
  body.insertParagraph(0, resumo).setHeading(DocumentApp.ParagraphHeading.NORMAL);
  body.insertParagraph(0, "RESUMO").setHeading(DocumentApp.ParagraphHeading.HEADING1);
}

// --- 5. L√ìGICA DE SOBERANIA (CHAVE MESTRA) ---
function unlockAdmin() {
  const ui = DocumentApp.getUi();
  const input = ui.prompt("üîê ACESSO √Ä SOBERANIA", "Digite a chave para mudar cores/design:", ui.ButtonSet.OK_CANCEL);
  
  if (input.getResponseText() === MASTER_CONFIG.CHAVE_MESTRA) {
    ui.alert("Acesso Liberado. Voc√™ pode alterar o esquema de cores agora.");
  } else {
    ui.alert("Chave incorreta. O site continua no modo P√öBLICO para visualiza√ß√£o.");
  }
}

// --- 6. INTERFACE SIDEBAR (FEEDBACK & CHECKLIST) ---
function openAdvisorSidebar() {
  const html = HtmlService.createHtmlOutput(`
    <style>
      body { font-family: 'Arial'; background-color: #f4f7f6; padding: 15px; }
      .card { background: white; border-radius: 8px; padding: 12px; margin-bottom: 10px; border-left: 4px solid #3498db; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
      .btn { background: #2c3e50; color: white; border: none; padding: 10px; width: 100%; border-radius: 4px; cursor: pointer; }
      .check { font-size: 12px; color: #555; }
    </style>
    <h3>ü§ñ Advisor V48.5</h3>
    <div class="card">
      <strong>Contexto:</strong> PSA Ipojuca / AHP<br>
      <small>Status: Monitorando escrita...</small>
    </div>
    <div class="card">
      <p class="check">‚úÖ Margens 3-3-2-2 (Pronto)</p>
      <p class="check">‚úÖ Fonte Arial 12 (Pronto)</p>
      <p class="check">‚úÖ Cita√ß√µes > 3 linhas (Autom√°tico)</p>
    </div>
    <button class="btn" onclick="google.script.run.runFullABNT()">‚ö° RE-FORMATAR TUDO</button>
  `).setTitle('Painel de Controle Luana');
  DocumentApp.getUi().showSidebar(html);
}
