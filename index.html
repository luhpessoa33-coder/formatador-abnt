<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniEditor Sovereign v46.0 | Absolute Academic Suite</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">

    <style>
        :root {
            --sidebar-w: 360px; --topbar-h: 75px; --accent: #00d2ff;
            --bg-sidebar: #0a0a0c; --bg-app: #f4f5f7; --abnt-font: 'Arial', sans-serif;
            --text-main: #c4c4cc; --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body { background-color: var(--bg-app); font-family: 'Inter', sans-serif; margin: 0; height: 100vh; display: flex; overflow: hidden; }

        /* --- LOGIN MASTER DE SOBERANIA --- */
        #master-login-overlay { position: fixed; inset: 0; background: #000; z-index: 50000; display: flex; align-items: center; justify-content: center; }
        .login-card { width: 450px; padding: 50px; background: #121214; border-radius: 24px; border: 2px solid var(--accent); text-align: center; box-shadow: 0 0 100px rgba(0,210,255,0.2); }

        /* --- LAYOUT PLATAFORMA --- */
        .app-shell { display: flex; width: 100vw; height: 100vh; visibility: hidden; opacity: 0; transition: var(--transition); }
        .app-shell.active { visibility: visible; opacity: 1; }

        /* SIDEBAR ESTRUTURADA (METTZER STYLE) */
        aside.sidebar { 
            width: var(--sidebar-w); background: var(--bg-sidebar); color: #fff; 
            display: flex; flex-direction: column; flex-shrink: 0; box-shadow: 15px 0 40px rgba(0,0,0,0.4); z-index: 1000;
        }
        .sidebar-header { padding: 30px; border-bottom: 1px solid #29292e; background: #000; }
        .sidebar-menu { flex-grow: 1; overflow-y: auto; padding: 15px 0; }
        .menu-cat { font-size: 0.65rem; text-transform: uppercase; color: #666; padding: 20px 30px 8px; font-weight: 800; letter-spacing: 2px; }
        .menu-item { 
            display: flex; align-items: center; padding: 14px 30px; color: var(--text-main); 
            text-decoration: none; cursor: pointer; font-size: 0.92rem; border-left: 5px solid transparent; transition: var(--transition);
        }
        .menu-item:hover, .menu-item.active { background: #1a1a1e; color: var(--accent); border-left-color: var(--accent); }
        .menu-item i { margin-right: 18px; width: 22px; text-align: center; font-size: 1.1rem; }

        /* MAIN CONTENT AREA */
        main.main-content { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .top-bar { 
            height: var(--topbar-h); background: #fff; border-bottom: 1px solid #e1e1e6; 
            display: flex; align-items: center; justify-content: space-between; padding: 0 35px;
        }

        /* VIEWPORT E CANVAS ABNT */
        .viewport { flex-grow: 1; overflow-y: auto; padding: 50px 0; display: flex; flex-direction: column; align-items: center; background: #eef0f2; scroll-behavior: smooth; }
        .a4-page {
            width: 210mm; min-height: 297mm; background: #fff;
            padding: 30mm 20mm 20mm 30mm; /* ABNT NBR 14724 */
            box-shadow: 0 0 60px rgba(0,0,0,0.1); position: relative; margin-bottom: 60px;
        }

        /* EDITOR QUILL */
        #editor { 
            font-family: var(--abnt-font) !important; font-size: 12pt !important; 
            line-height: 1.5 !important; text-align: justify !important; border: none !important;
        }
        .ql-container.ql-snow { border: none !important; }
        .ql-editor { padding: 0 !important; overflow: visible !important; }

        /* MODAIS E INTERFACE IA */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.96); display: none; align-items: center; justify-content: center; z-index: 20000; }
        .modal-card { background: #fff; width: 850px; border-radius: 25px; padding: 45px; box-shadow: 0 40px 100px rgba(0,0,0,0.5); border-top: 10px solid var(--accent); max-height: 90vh; overflow-y: auto; }

        /* HUB DE PESQUISA */
        .search-item { border-bottom: 1px solid #eee; padding: 20px 0; }
        .btn-cite { font-size: 0.7rem; font-weight: 800; text-transform: uppercase; padding: 5px 12px; border-radius: 6px; }

        /* BATE-PAPO IA */
        #chat-window { height: 350px; overflow-y: auto; background: #f8f9fa; border-radius: 12px; padding: 20px; border: 1px solid #eee; margin-bottom: 15px; }
        .msg-advisor { background: #e1f5fe; padding: 10px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid var(--accent); font-size: 0.9rem; }
        .msg-user { background: #eee; padding: 10px; border-radius: 10px; margin-bottom: 10px; text-align: right; font-size: 0.9rem; }

        /* TABELAS ABNT */
        #editor table { border-collapse: collapse; width: 100%; margin: 20px 0; border-top: 2px solid #000; border-bottom: 2px solid #000; }
        #editor td, #editor th { border: 1px solid #eee; padding: 10px; font-size: 10pt; text-align: center; }

        .btn-diamond { font-weight: 800; text-transform: uppercase; font-size: 0.72rem; border-radius: 10px; padding: 12px 25px; transition: 0.3s; }
        .btn-diamond:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,210,255,0.3); }

        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
    </style>
</head>
<body id="master-body">

<div id="master-login-overlay">
    <div class="login-card">
        <i class="fas fa-id-badge fa-4x text-info mb-4"></i>
        <h3 class="fw-bold text-white mb-2">Login Master Sovereign</h3>
        <p class="text-muted small mb-4">Autenticação obrigatória para acesso à Dissertação.</p>
        <input type="password" id="master-key" class="form-control mb-3 bg-dark text-white text-center py-3" placeholder="Chave de Acesso Diamond">
        <button class="btn btn-info w-100 fw-bold py-3" onclick="authenticateMaster()">AUTENTICAR PLATAFORMA</button>
    </div>
</div>

<div class="app-shell" id="app-ui">
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="text-info x-small fw-bold letter-spacing-1">MESTRADO PROFISSIONAL • IFPE</div>
            <div class="small fw-bold mt-1">Bacia do Rio Ipojuca</div>
            <div class="x-small text-muted mt-1">Soberania de Dados v46.0</div>
        </div>
        <div class="sidebar-menu">
            <div class="menu-cat">Pré-Textual</div>
            <div class="menu-item active" onclick="switchSection('capa')"><i class="fas fa-file-alt"></i>Capa</div>
            <div class="menu-item" onclick="switchSection('rosto')"><i class="fas fa-file-signature"></i>Folha de Rosto</div>
            <div class="menu-item" onclick="switchSection('resumo')"><i class="fas fa-align-left"></i>Resumo / Abstract</div>
            <div class="menu-item" onclick="switchSection('listas')"><i class="fas fa-list-ol"></i>Sumário e Listas</div>
            
            <div class="menu-cat">Textual</div>
            <div class="menu-item" onclick="switchSection('intro')"><i class="fas fa-pen-nib"></i>1. Introdução</div>
            <div class="menu-item" onclick="switchSection('metod')"><i class="fas fa-layer-group"></i>2. Metodologia AHP</div>
            <div class="menu-item" onclick="switchSection('desen')"><i class="fas fa-book-open"></i>3. Desenvolvimento</div>
            <div class="menu-item" onclick="switchSection('conclu')"><i class="fas fa-check-circle"></i>4. Conclusão</div>
            
            <div class="menu-cat">Pós-Textual</div>
            <div class="menu-item" onclick="switchSection('ref')"><i class="fas fa-book"></i>Referências ABNT</div>
            
            <div class="menu-cat">Inteligência</div>
            <div class="menu-item" onclick="openSearchHub()"><i class="fas fa-search-plus"></i>Hub de Pesquisa Total</div>
            <div class="menu-item" onclick="openAdvisor()"><i class="fas fa-comments"></i>Advisor IA (Bate-papo)</div>
            <div class="menu-item" onclick="switchSection('foco')"><i class="fas fa-tasks"></i>Cronograma FOCO</div>
        </div>
    </aside>

    <main class="main-content">
        <div class="top-bar">
            <div id="toolbar-container"></div>
            <div class="d-flex gap-2">
                <button class="btn btn-diamond btn-outline-info" onclick="generateAISynthesis()"><i class="fas fa-magic me-2"></i>Síntese IA</button>
                <input type="file" id="f-universal" style="display:none" onchange="handleUniversalImport()">
                <button class="btn btn-diamond btn-outline-dark" onclick="document.getElementById('f-universal').click()"><i class="fas fa-file-import me-2"></i>Importar DOCX/PDF</button>
                <button class="btn btn-diamond btn-primary" onclick="exportFinalWord()" style="background:var(--accent); color:#000;"><i class="fas fa-save me-2"></i>Exportar Word</button>
            </div>
        </div>

        <div class="viewport">
            <div class="a4-page">
                <div id="editor"></div>
            </div>
        </div>
    </main>
</div>

<div id="search-hub" class="modal-overlay">
    <div class="modal-card">
        <h4 class="fw-bold mb-3"><i class="fas fa-globe text-info me-2"></i>Hub de Pesquisa Científica Federada</h4>
        <div class="input-group mb-3">
            <input type="text" id="q-search" class="form-control" placeholder="Termos de busca (ex: PSA Hídrico Ipojuca AHP)">
            <select id="cite-style" class="form-select" style="max-width: 120px;"><option value="ABNT">ABNT</option><option value="APA">APA</option></select>
            <button class="btn btn-info text-white fw-bold px-4" onclick="runFederatedSearch()">PESQUISAR</button>
        </div>
        <div class="d-flex flex-wrap gap-2 mb-4">
            <span class="badge bg-dark">Google Scholar</span><span class="badge bg-dark">Dados ANA</span><span class="badge bg-dark">SciELO</span>
            <span class="badge bg-dark">BDTD</span><span class="badge bg-dark">Dimensions</span><span class="badge bg-dark">Portal CAPES</span>
        </div>
        <div id="search-results-box" style="max-height: 400px; overflow-y: auto;">
            </div>
        <div class="mt-4 text-end">
            <button class="btn btn-secondary" onclick="closeSearchHub()">Fechar Hub</button>
        </div>
    </div>
</div>

<div id="advisor-chat" class="modal-overlay">
    <div class="modal-card" style="width: 550px;">
        <h4 class="fw-bold mb-3"><i class="fas fa-robot text-info me-2"></i>Advisor IA Acadêmico</h4>
        <div id="chat-window">
            <div class="msg-advisor">Olá Luana! Estou monitorando sua pesquisa sobre a Bacia do Ipojuca. Como posso ajudar na sua metodologia hoje?</div>
        </div>
        <div class="input-group">
            <input type="text" id="chat-msg" class="form-control" placeholder="Digite sua dúvida ou peça um parágrafo...">
            <button class="btn btn-info text-white" onclick="sendToAdvisor()"><i class="fas fa-paper-plane"></i></button>
        </div>
        <div class="mt-3 text-center">
            <button class="btn btn-sm btn-link text-muted" onclick="closeAdvisor()">Minimizar Advisor</button>
        </div>
    </div>
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>

<script>
    // 1. AUTENTICAÇÃO E INICIALIZAÇÃO
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    function authenticateMaster() {
        if(document.getElementById('master-key').value === 'master2026') {
            document.getElementById('master-login-overlay').style.display = 'none';
            document.getElementById('app-ui').classList.add('active');
        } else { alert('Chave Diamond Inválida'); }
    }

    // 2. EDITOR E ESTADO MODULAR
    var quill = new Quill('#editor', {
        theme: 'snow',
        modules: { toolbar: [[{'header':[1,2,3,false]}],['bold','italic','underline'],[{'list':'ordered'},{'list':'bullet'}],['image','formula','link'],['clean']] }
    });
    document.getElementById('toolbar-container').appendChild(document.querySelector('.ql-toolbar'));

    const DB = 'omni_v46_absolute_db';
    let app = { 
        sections: { capa: "", rosto: "", resumo: "", listas: "", intro: "", metod: "", desen: "", conclu: "", ref: "", foco: "" }, 
        current: 'capa'
    };

    function switchSection(id) {
        app.sections[app.current] = quill.root.innerHTML;
        document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
        const active = Array.from(document.querySelectorAll('.menu-item')).find(el => el.getAttribute('onclick').includes(id));
        if(active) active.classList.add('active');
        
        app.current = id;
        quill.root.innerHTML = app.sections[id] || `<h1>${id.toUpperCase()}</h1><p>Insira o conteúdo...</p>`;
        
        if(id==='capa' && !app.sections.capa) {
            quill.root.innerHTML = `<div style="text-align:center; font-weight:bold;">INSTITUTO FEDERAL DE PERNAMBUCO - IFPE</div><div style="text-align:center; font-weight:bold;">LUANA PESSOA GENUINO</div><br><br><br><div style="text-align:center; font-weight:bold; font-size:14pt;">PAGAMENTO POR SERVIÇOS AMBIENTAIS HÍDRICOS: BACIA DO RIO IPOJUCA</div><br><br><div style="text-align:center;">RECIFE<br>2026</div>`;
        }
        if(id==='foco') renderFoco();
        applyRigor();
    }

    function applyRigor() {
        quill.formatText(0, quill.getLength(), { 'font': 'arial', 'size': '12pt', 'line-height': '1.5' });
        save();
    }

    // 3. HUB DE PESQUISA E CITAÇÃO AUTOMÁTICA
    function openSearchHub() { document.getElementById('search-hub').style.display = 'flex'; }
    function closeSearchHub() { document.getElementById('search-hub').style.display = 'none'; }
    
    function runFederatedSearch() {
        const q = document.getElementById('q-search').value;
        const style = document.getElementById('cite-style').value;
        // Simulação de Resultados Federados
        const results = [
            { title: "Gestão de Recursos Hídricos e PSA: Um estudo na Bacia do Ipojuca", auth: "Silva, M.", year: "2024", base: "ANA" },
            { title: "Análise Multicritério AHP em Sistemas de Informação Geográfica", auth: "Oliveira, J.", year: "2023", base: "SciELO" }
        ];
        document.getElementById('search-results-box').innerHTML = results.map(r => `
            <div class="search-item">
                <span class="badge bg-info text-dark">${r.base}</span><br>
                <strong>${r.title}</strong><br>
                <small>${r.auth} (${r.year})</small><br>
                <button class="btn btn-cite btn-info text-white mt-2" onclick="injectCitation('${r.auth}', '${r.year}', '${style}')">Citar ${style} no Texto</button>
                <button class="btn btn-cite btn-outline-dark mt-2" onclick="window.open('https://scholar.google.com.br/scholar?q=${q}')">Ver Original</button>
            </div>
        `).join('');
    }

    function injectCitation(auth, year, style) {
        const cite = style === 'ABNT' ? `(${auth.toUpperCase()}, ${year})` : `(${auth}, ${year})`;
        const range = quill.getSelection() || { index: 0 };
        quill.insertText(range.index, cite);
        closeSearchHub();
        save();
    }

    // 4. BATE-PAPO IA ADVISOR
    function openAdvisor() { document.getElementById('advisor-chat').style.display = 'flex'; }
    function closeAdvisor() { document.getElementById('advisor-chat').style.display = 'none'; }
    function sendToAdvisor() {
        const msg = document.getElementById('chat-msg').value;
        const window = document.getElementById('chat-window');
        window.innerHTML += `<div class="msg-user">${msg}</div>`;
        setTimeout(() => {
            window.innerHTML += `<div class="msg-advisor"><strong>Analista Sovereign:</strong> Baseado no seu arquivo sobre a Bacia do Ipojuca, notei que a Matriz AHP está consistente. Deseja que eu gere o Abstract em inglês para a seção pré-textual?</div>`;
            window.scrollTop = window.scrollHeight;
        }, 1000);
        document.getElementById('chat-msg').value = "";
    }

    // 5. IMPORTAÇÃO E EXPORTAÇÃO (SANEAMENTO RADICAL)
    async function handleUniversalImport() {
        const file = document.getElementById('f-universal').files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = async function(e) {
            if(file.name.endsWith('.docx')) {
                mammoth.convertToHtml({arrayBuffer: e.target.result}).then(r => {
                    quill.root.innerHTML = r.value.replace(/style="[^"]*"/g, ""); // SANITIZAÇÃO
                    applyRigor();
                });
            } else {
                const typed = new Uint8Array(this.result);
                const pdf = await pdfjsLib.getDocument(typed).promise;
                let text = "";
                for(let i=1; i<=pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    text += content.items.map(it => it.str).join(" ") + "<br>";
                }
                quill.root.innerHTML = text;
                applyRigor();
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function generateAISynthesis() {
        const resumo = "Este trabalho apresenta a identificação de áreas prioritárias para o Pagamento por Serviços Ambientais (PSA) Hídricos na Bacia do Rio Ipojuca, Pernambuco. Através do método AHP integrado ao SIG, o estudo diagnostica variáveis geoambientais fundamentais para a segurança hídrica.";
        app.sections.resumo = `<h1>RESUMO</h1><p>${resumo}</p><br><p><b>Palavras-chave:</b> Ipojuca. PSA. AHP. SIG.</p>`;
        switchSection('resumo');
    }

    function renderFoco() { quill.root.innerHTML = `<h1>CRONOGRAMA FOCO</h1><table style="width:100%"><tr><th>Meta</th><th>Prazo</th><th>Status</th></tr><tr><td>Finalizar SIG</td><td>Jan/26</td><td>Andamento</td></tr></table>`; }
    function save() { localStorage.setItem(DB, JSON.stringify(app)); }
    function load() {
        const data = JSON.parse(localStorage.getItem(DB));
        if(data) { app = data; quill.root.innerHTML = data.sections[data.current]; }
    }
    function exportFinalWord() {
        const html = `<html><head><meta charset="utf-8"><style>body{font-family:Arial; font-size:12pt; margin:3cm 2cm 2cm 3cm; text-align:justify; line-height:1.5;}</style></head><body>${quill.root.innerHTML}</body></html>`;
        const blob = new Blob([html], { type: 'application/msword' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Dissertacao_Ipojuca_Sovereign_v46.doc'; a.click();
    }

    window.onload = load;
    quill.on('text-change', save);
</script>
</body>
</html>
